# 地震情報受信システムの歴史と技術調査レポート

## 目次
1. [はじめに](#はじめに)
2. [Kiwi Monitorとその時代](#kiwi-monitorとその時代)
3. [強震モニタExtensionの仕組み](#強震モニタextensionの仕組み)
4. [データフォーマットと最終報判定](#データフォーマットと最終報判定)
5. [現在の状況と課題](#現在の状況と課題)
6. [補記: OpenJTalkによる音声合成の提案](#補記-openjtalkによる音声合成の提案)
7. [参考文献](#参考文献)

---

## はじめに

本レポートは、かつて無料で利用できた地震情報受信アプリケーション（特にKiwi Monitor、Kyoshin EEW Viewer等）がどのような仕組みで動作していたのか、そして現在なぜそれらが利用できなくなったのかを調査したものです。

調査の結果、これらのアプリケーションは**防災科学技術研究所（防災科研）が提供する「強震モニタ」のデータを非公式に利用**していたこと、そしてそのデータ形式には**明示的な最終報フラグ**が存在していたことが判明しました。

---

## Kiwi Monitorとその時代

### 概要

Kiwi Monitorは、Kyoshin EEW Viewerの後継ソフトとして2018年5月20日に公開された、Windows向けの地震情報表示ソフトウェアです。

**主な機能:**
- 強震モニタの観測データをリアルタイム表示
- 緊急地震速報（EEW）の受信と表示
- Yahoo!サイトからの地震・津波情報取得
- 音声による通知機能
- 震度検知機能

> 参考: [Kiwi Monitor Version1.0.0公開記事](https://kiwimonitor.amebaownd.com/posts/4229722/)

### 音声通知の詳細設定

Kiwi MonitorとKyoshin EEW Viewerの大きな特徴は、**EEWの報数ごとに異なる音声ファイルを設定できた**点です。

**設定可能な音声種別:**
1. **第1報受信時**: 最初にEEWを受信した時
2. **継続報受信時**: 第2報、第3報などの更新時
3. **最終報受信時**: 最後のEEWを受信した時
4. **警報受信時**: 震度5弱以上と予想された時
5. **強震震度音声**: 強震モニタで揺れを検知した時

つまり、ユーザーは以下のような運用が可能でした:
- 第1報で「緊急地震速報」チャイムと震度を読み上げ
- 継続報では簡易的なチャイム音のみ
- 最終報で「震度○、最終」と明確に通知

> 参考: 
> - [Kyoshin EEW Viewer 音声設定の解説](https://greenapple-room.com/tools/179.html)
> - [Kyoshin EEW Viewer 開発者サイト](http://compo031.daiwa-hotcom.com/wordpress/?p=29)

### 技術的な改良点

Kyoshin EEW ViewerからKiwi Monitorへの移行で実装された重要な改良:

1. **キャンセル報対応**
   - 2016年8月の東京湾M9.1誤報事件の教訓
   - 「キャンセル報が発表された可能性が高い」場合に表示を即座に停止
   
2. **深発地震対応**
   - 予測震源深さが150kmより深く変化した場合の対応
   - 2015年小笠原諸島西方沖地震での問題を解消
   - 古い情報を表示し続けることを防止

> 参考: [Kiwi Monitor Version1.0.0公開記事 - 技術的改良点](https://kiwimonitor.amebaownd.com/posts/4229722/)

### 開発終了の経緯

**2019年10月**: 防災科研が強震モニタのアクセスURL変更
- 全バージョンが動作不能に
- 緊急対応版を一時配布

**2021年**: 強震モニタの利用規約改定
- 個人開発アプリでの利用が実質的に制限
- 開発者から利用中止のアナウンス
- アプリケーションの公開停止

> 参考:
> - [Kiwi Monitor Version1.5.0公開記事 - URL変更対応](https://kiwimonitor.amebaownd.com/posts/7048905/)
> - [緊急地震速報をパソコンで受信する方法](https://js2y.com/eew/)

---

## 強震モニタExtensionの仕組み

### アーキテクチャ

Kiwi Monitorは、実は**直接WebSocketで強震モニタに接続していたわけではない**可能性が高いです。調査の結果、以下のような多層構造が明らかになりました:

```
[防災科研 強震モニタ]
        ↓ (画像・JSONデータ配信)
[強震モニタExtension (Chrome拡張機能)]
        ↓ (ローカルWebSocketまたはHTTP POST)
[Kiwi Monitor / その他アプリ]
```

### 強震モニタExtensionの役割

強震モニタExtension（Chrome拡張機能）は以下の処理を行っていました:

1. **データ取得**
   - 防災科研の強震モニタから以下を取得:
     - 強震観測点データ（GIF画像、1秒ごと更新）
     - EEW JSONデータ
     - 予想震度図（GIF画像）
     - P/S波の円と震央（GIF画像）

2. **データ解析**
   - JSONデータのパース
   - 画像からの震度情報抽出
   - 報数の判定

3. **データ配信**
   - ローカルWebサーバー（Python/Node.js等）へJSON送信
   - 設定で送信先URLを指定可能（例: `http://localhost:8000`）

> 参考: [強震モニタ考察 - データおよび情報の処理方法](https://melanion.info/kyoshin/)

### 実際の実装例

ある開発者の実装記録によると、以下のようなデータフローでした:

```
強震モニタExtension
  → CentOS7上のGoogle Chrome
    → Pythonで書かれたWebサーバー
      → Discord/Slack/Twitter API
```

この方式により、Chrome拡張機能がデータを取得・解析し、それを外部アプリケーションに配信する形で実現されていました。

> 参考: [緊急地震速報を強震モニタで受け取りJSONで扱うとめっちゃ速い](https://qiita.com/Takagi_/items/fc88b692ca6fadd16cb2)

---

## データフォーマットと最終報判定

### 強震モニタのEEWデータ形式

強震モニタExtensionから送信されるJSONデータには、**明示的な最終報フラグ**が存在しました:

```json
{
  "type": "eew",
  "time": "1589131429000",
  "report": "1",          // 第1報: "1"
  "epicenter": "伊予灘",
  "depth": "60km",
  "magnitude": 3.5,
  "latitude": 33.8,
  "longitude": 132.1,
  "intensity": "2",
  "index": 2
}
```

**reportフィールドの値:**
- 第1報: `"1"`
- 第2報: `"2"`
- 第3報: `"3"`
- ...
- **最終報**: `"final"` ← **明示的な文字列**

この`"final"`フラグの存在により、Kiwi Monitorは確実に最終報を判定し、専用の音声（「震度○、最終」）を再生できました。

> 参考: [緊急地震速報を強震モニタで受け取りJSONで扱うとめっちゃ速い - データフォーマット](https://qiita.com/Takagi_/items/fc88b692ca6fadd16cb2)

### 気象庁データとの違い

一方、気象庁から直接配信される緊急地震速報には、このような明示的な最終報フラグは**存在しません**。

**気象庁のデータ仕様:**
- `issue.serial`: 報数（"1", "2", "3", ...）
- キャンセル報: 1つ前と同じSerialが振られる
- 最終報: 明示的なフラグなし

つまり、**強震モニタExtensionが独自に最終報を判定して`"final"`を付与していた**可能性が高いです。

判定ロジックの推測:
1. 一定時間（例: 3分）新しい報が来ない
2. 予測震度が安定した
3. 後続の地震情報（確定情報）が発表された

> 参考: 
> - [DMDATA.JP - EEWについて](https://dmdata.jp/docs/eew/)
> - [Wikipedia - 緊急地震速報](https://ja.wikipedia.org/wiki/緊急地震速報)

---

## 現在の状況と課題

### なぜ利用できなくなったのか

1. **防災科研の方針変更**
   - 強震モニタの利用規約改定（2021年）
   - 個人開発アプリでの非公式利用を制限
   - URL変更やアクセス制限の強化

2. **データ提供形態の変化**
   - かつて: 非公式だが黙認されていた
   - 現在: 明確に制限

3. **開発者の対応**
   - 開発停止・公開停止のアナウンス
   - 利用中止の呼びかけ

> 参考: [緊急地震速報をパソコンで受信する方法 - 各種アプリの状況](https://js2y.com/eew/)

### 現在の代替手段

**公式・準公式:**
- スマートフォンの緊急速報（無料、詳細情報は限定的）
- SignalNow X有料版
- その他気象情報会社の有料サービス

**コミュニティベース:**
- **P2P地震情報** ← 本プロジェクトで採用
  - DMDATA.JPからの正規配信を無料提供
  - WebSocket APIで低遅延受信
  - 商用・非商用問わず利用可能
  - ただし最終報フラグはなし

> 参考: 
> - [P2P地震情報 公式サイト](https://www.p2pquake.net/)
> - [P2P地震情報 開発者向けコンテンツ](https://www.p2pquake.net/develop/)

### 最終報判定の現状

P2P地震情報APIでは、強震モニタのような`"final"`フラグは存在しません。

**現実的な判定方法:**

1. **event_idで判定**
   ```
   新しいevent_idが来た
   → 前のイベントは終了（最終報だった）
   ```

2. **タイムアウトで判定**
   ```
   最後のEEWから3分経過
   → 最終報とみなす
   ```

3. **地震情報(code 551)で判定**
   ```
   確定した地震情報が来た
   → EEWは終了
   ```

4. **使わない**
   ```
   第1報と続報のみ実装
   最終報フォルダは使用しない
   ```

---

## 補記: OpenJTalkによる音声合成の提案

### なぜ音声合成が有用か

従来の音声ファイル方式では:
- 「震度○」の単純な読み上げのみ
- 震源地、マグニチュード、地域名などの詳細情報は読み上げ不可
- 音声ファイルの管理が煩雑

**OpenJTalkを使えば:**
- JSONデータから動的にテキストを生成
- 「震度6強、東京都、マグニチュード7.2」のような詳細な読み上げ
- 音声ファイル不要
- Ubuntu Serverで完全オフライン動作

### OpenJTalkとは

Open JTalkは名古屋工業大学で開発された日本語テキスト音声合成ソフトウェアで、HMM（隠れマルコフモデル）を採用しており、少ないメモリでも動作するのが特徴です。

**特徴:**
- 完全オフライン動作
- 軽量（Raspberry Piでも動作）
- 話速、ピッチ、音量の調整可能
- 無料・オープンソース

> 参考: [Wikipedia - Open JTalk](https://ja.wikipedia.org/wiki/Open_JTalk)

### インストール方法

**Ubuntu Serverの場合:**

```bash
# パッケージのインストール
sudo apt update
sudo apt install open-jtalk open-jtalk-mecab-naist-jdic hts-voice-nitech-jp-atr503-m001
```

**インストール後の確認:**

```bash
# 辞書の場所を確認
ls /var/lib/mecab/dic/open-jtalk/naist-jdic

# 音声モデルの場所を確認
ls /usr/share/hts-voice/nitech-jp-atr503-m001/
```

> 参考: [Ubuntu Open JTalk その1 - kledgeb](https://kledgeb.blogspot.com/2014/05/ubuntu-open-jtalk-1-open-jtalkopen-jtalk.html)

### 基本的な使い方

#### 1. テキストファイルから音声生成

```bash
# テキストファイルを作成
echo "震度5弱の地震が発生しました。震源地は東京湾です。" > test.txt

# 音声ファイルを生成
open_jtalk \
  -x /var/lib/mecab/dic/open-jtalk/naist-jdic \
  -m /usr/share/hts-voice/nitech-jp-atr503-m001/nitech_jp_atr503_m001.htsvoice \
  -ow output.wav \
  test.txt

# 再生
aplay output.wav
```

#### 2. ワンライナーで実行

```bash
echo "緊急地震速報。震度6強が予想されます。" | \
open_jtalk \
  -x /var/lib/mecab/dic/open-jtalk/naist-jdic \
  -m /usr/share/hts-voice/nitech-jp-atr503-m001/nitech_jp_atr503_m001.htsvoice \
  -ow /tmp/eew.wav && \
aplay /tmp/eew.wav
```

> 参考: [Ubuntu Open JTalk その2 - open_jtalkコマンドの説明](https://kledgeb.blogspot.com/2014/05/ubuntu-open-jtalk-2-openjtalk.html)

### パラメータ調整

#### 話速の調整

```bash
# 標準速度（1.0）
open_jtalk ... -r 1.0 ...

# 速め（緊急時推奨: 1.2）
open_jtalk ... -r 1.2 ...

# 遅め（ゆっくり: 0.8）
open_jtalk ... -r 0.8 ...
```

#### ピッチの調整

```bash
# 標準（0）
open_jtalk ... -fm 0 ...

# 高め（+50）
open_jtalk ... -fm 50 ...

# 低め（-50）
open_jtalk ... -fm -50 ...
```

#### 組み合わせ例

```bash
# 緊急時: 速めで高めの声
echo "緊急地震速報" | \
open_jtalk \
  -x /var/lib/mecab/dic/open-jtalk/naist-jdic \
  -m /usr/share/hts-voice/nitech-jp-atr503-m001/nitech_jp_atr503_m001.htsvoice \
  -r 1.2 \
  -fm 30 \
  -ow /tmp/eew.wav && \
aplay /tmp/eew.wav
```

### 実験: 地震情報の読み上げシミュレーション

#### EEW（緊急地震速報）の読み上げ

```bash
# テキスト生成
cat > eew_test.txt << 'EOF'
緊急地震速報。第1報です。
震源地は東京湾。
予想最大震度は震度6強。
マグニチュード7.2。
東京都23区、震度6強。
神奈川県東部、震度6弱。
千葉県北西部、震度5強。
EOF

# 音声生成・再生
open_jtalk \
  -x /var/lib/mecab/dic/open-jtalk/naist-jdic \
  -m /usr/share/hts-voice/nitech-jp-atr503-m001/nitech_jp_atr503_m001.htsvoice \
  -r 1.2 \
  -fm 20 \
  -ow eew_test.wav \
  eew_test.txt

aplay eew_test.wav
```

#### 地震情報（確定情報）の読み上げ

```bash
# テキスト生成
cat > quake_info.txt << 'EOF'
地震情報です。
2025年10月21日、午前3時35分頃、
東京湾を震源とする地震がありました。
最大震度は震度5弱。
マグニチュードは5.2。
深さは30キロメートル。
主な地域は、
東京都大田区、震度5弱、
神奈川県川崎市、震度4、
千葉県市川市、震度4、
です。
EOF

# 音声生成・再生（標準速度で）
open_jtalk \
  -x /var/lib/mecab/dic/open-jtalk/naist-jdic \
  -m /usr/share/hts-voice/nitech-jp-atr503-m001/nitech_jp_atr503_m001.htsvoice \
  -r 1.0 \
  -ow quake_info.wav \
  quake_info.txt

aplay quake_info.wav
```

### Pythonからの利用例（概念）

```python
import subprocess
import tempfile
import os

def speak_openjtalk(text, speed=1.0, pitch=0):
    """OpenJTalkでテキストを読み上げる"""
    # 一時ファイル作成
    with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as txt_file:
        txt_file.write(text)
        txt_path = txt_file.name
    
    with tempfile.NamedTemporaryFile(suffix='.wav', delete=False) as wav_file:
        wav_path = wav_file.name
    
    # OpenJTalkで音声合成
    subprocess.run([
        'open_jtalk',
        '-x', '/var/lib/mecab/dic/open-jtalk/naist-jdic',
        '-m', '/usr/share/hts-voice/nitech-jp-atr503-m001/nitech_jp_atr503_m001.htsvoice',
        '-r', str(speed),
        '-fm', str(pitch),
        '-ow', wav_path,
        txt_path
    ])
    
    # aplayで再生
    subprocess.run(['aplay', '-q', wav_path])
    
    # クリーンアップ
    os.unlink(txt_path)
    os.unlink(wav_path)

# 使用例
speak_openjtalk("震度5弱の地震が発生しました", speed=1.2, pitch=20)
```

### 音声品質の向上

#### より自然な音声モデル（追加インストール）

```bash
# 女性の声
sudo apt install hts-voice-nitech-jp-atr503-m001

# 感情表現可能な音声（別途ダウンロード必要）
# 東北大学の感情音声など
```

#### 発音の調整

特定の単語（「震度」「マグニチュード」など）の読み方を調整したい場合は、ユーザー辞書を作成することも可能です。

### systemdでのサービス化

音声再生を含むシステムをバックグラウンドで動作させる場合:

```ini
[Unit]
Description=Earthquake Alert System with OpenJTalk
After=network-online.target sound.target
Wants=network-online.target

[Service]
Type=simple
User=your-username
Environment="AUDIODEV=hw:0,0"
ExecStart=/usr/bin/python3 /path/to/your_script.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

---

## まとめ

1. **Kiwi Monitorの仕組み**
   - 強震モニタExtension（Chrome拡張）経由でデータ取得
   - 明示的な`"final"`フラグで最終報を判定
   - 報数ごとに異なる音声再生が可能

2. **現在の状況**
   - 強震モニタの非公式利用は制限
   - P2P地震情報が実用的な代替手段
   - ただし最終報フラグは存在しない

3. **OpenJTalkの活用**
   - 音声ファイル不要で動的な読み上げ
   - Ubuntu Serverで完全オフライン動作
   - JSONデータから詳細情報を生成可能

本プロジェクトでは、P2P地震情報APIとOpenJTalk（または既存の音声ファイル）を組み合わせることで、かつてのKiwi Monitorに匹敵する（あるいはそれ以上の）地震情報通知システムを実現できます。

---

## 参考文献

### Kiwi Monitor / Kyoshin EEW Viewer関連
- [Kiwi Monitor Version1.0.0公開記事](https://kiwimonitor.amebaownd.com/posts/4229722/)
- [Kiwi Monitor Version1.5.0公開記事](https://kiwimonitor.amebaownd.com/posts/7048905/)
- [Kiwi Monitor 機能紹介ページ](https://kiwimonitor.amebaownd.com/pages/1891289/features)
- [Kyoshin EEW Viewer 開発者サイト](http://compo031.daiwa-hotcom.com/wordpress/?p=29)
- [Kyoshin EEW Viewer 音声設定の解説](https://greenapple-room.com/tools/179.html)

### 強震モニタ・データ構造関連
- [強震モニタ考察 - データおよび情報の処理方法](https://melanion.info/kyoshin/)
- [緊急地震速報を強震モニタで受け取りJSONで扱うとめっちゃ速い](https://qiita.com/Takagi_/items/fc88b692ca6fadd16cb2)

### 現状と代替手段
- [緊急地震速報をパソコンで受信する方法](https://js2y.com/eew/)
- [P2P地震情報 公式サイト](https://www.p2pquake.net/)
- [P2P地震情報 開発者向けコンテンツ](https://www.p2pquake.net/develop/)

### 気象庁・技術仕様関連
- [DMDATA.JP - EEWについて](https://dmdata.jp/docs/eew/)
- [Wikipedia - 緊急地震速報](https://ja.wikipedia.org/wiki/緊急地震速報)

### OpenJTalk関連
- [Wikipedia - Open JTalk](https://ja.wikipedia.org/wiki/Open_JTalk)
- [Ubuntu Open JTalk その1 - kledgeb](https://kledgeb.blogspot.com/2014/05/ubuntu-open-jtalk-1-open-jtalkopen-jtalk.html)
- [Ubuntu Open JTalk その2 - kledgeb](https://kledgeb.blogspot.com/2014/05/ubuntu-open-jtalk-2-openjtalk.html)
